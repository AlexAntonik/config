name: Check Configurations 

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  check-configs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v9

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v3

      - name: Check flake
        run: nix flake check --show-trace

      - name: Evaluate all NixOS configurations
        id: eval
        continue-on-error: true
        run: |
          mkdir -p .github/badges
          success_count=0
          fail_count=0
          
          for host in $(ls hosts/); do
            echo "========================================="
            echo "Evaluating configuration for $host..."
            echo "========================================="
            
            if nix eval .#nixosConfigurations.$host.config.system.build.toplevel.drvPath \
              --show-trace 2>&1; then
              status="passing"
              color="brightgreen"
              ((success_count++))
              echo "✓ $host evaluation succeeded"
            else
              status="failing"
              color="red"
              ((fail_count++))
              echo "✗ $host evaluation failed"
            fi
            
            cat > .github/badges/$host.json << EOF
          {
            "schemaVersion": 1,
            "label": "$host",
            "message": "$status",
            "color": "$color"
          }
          EOF
          done
          
          echo "success=$success_count" >> $GITHUB_OUTPUT
          echo "fail=$fail_count" >> $GITHUB_OUTPUT

      - name: Create summary badge
        run: |
          total=$(ls hosts/ | wc -l)
          success=${{ steps.eval.outputs.success }}
          
          if [ "$success" -eq "$total" ]; then
            color="brightgreen"
            message="$success/$total passing"
          elif [ "$success" -eq "0" ]; then
            color="red"
            message="$success/$total passing"
          else
            color="orange"
            message="$success/$total passing"
          fi
          
          cat > .github/badges/summary.json << EOF
          {
            "schemaVersion": 1,
            "label": "eval",
            "message": "$message",
            "color": "$color"
          }
          EOF

      - name: Update README with hosts table
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          cat > hosts_table.md << 'HEADER'
          ## Hosts
          
          ![Eval Status](https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/${{ github.repository }}/main/.github/badges/summary.json)
          
          | Host | Status |
          |------|--------|
          HEADER
          
          for host in $(ls hosts/ | sort); do
            echo "| \`$host\` | ![](https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/${{ github.repository }}/main/.github/badges/$host.json) |" >> hosts_table.md
          done
          
          if grep -q "<!-- HOSTS_START -->" README.md && grep -q "<!-- HOSTS_END -->" README.md; then
            awk '
              /<!-- HOSTS_START -->/ {print; system("cat hosts_table.md"); f=1; next}
              /<!-- HOSTS_END -->/ {f=0}
              !f
            ' README.md > README.md.tmp
            mv README.md.tmp README.md
          else
            echo "::warning::Markers <!-- HOSTS_START --> and <!-- HOSTS_END --> not found in README.md"
          fi

      - name: Commit changes
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .github/badges/ README.md
          git diff --quiet && git diff --staged --quiet || git commit -m "Update eval badges and hosts table [skip ci]"
          git push

      - name: Check evaluation results
        run: |
          if [ "${{ steps.eval.outputs.fail }}" -gt 0 ]; then
            echo "::error::${{ steps.eval.outputs.fail }} host(s) failed to evaluate"
            exit 1
          fi
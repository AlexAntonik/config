name: Check Configurations 

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  check-configs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v9

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@v3

      - name: Check flake
        run: nix flake check --show-trace

      - name: Evaluate all NixOS configurations
        id: eval
        continue-on-error: true
        run: |
          success=0
          fail=0
          badges=""
          
          for host in $(ls hosts/ | sort); do
            echo "========================================="
            echo "Evaluating configuration for $host..."
            echo "========================================="
            
            if nix eval .#nixosConfigurations.$host.config.system.build.toplevel.drvPath \
              --show-trace 2>&1; then
              color="green"
              status="passing"
              success=$((success + 1))
              echo "✓ $host evaluation succeeded"
            else
              color="red"
              status="failing"
              fail=$((fail + 1))
              echo "✗ $host evaluation failed"
            fi
            
            badges="${badges}![$host](https://badgen.net/badge/$host/$status/$color) "
          done
          
          echo "badges=$badges" >> $GITHUB_OUTPUT
          echo "success=$success" >> $GITHUB_OUTPUT
          echo "fail=$fail" >> $GITHUB_OUTPUT

      - name: Update README with host badges
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          cat > hosts_badges.md << 'EOF'
            ## Hosts

            ${{ steps.eval.outputs.badges }}
          EOF
          
          if grep -q "<!-- HOSTS_START -->" README.md && grep -q "<!-- HOSTS_END -->" README.md; then
            awk '
              /<!-- HOSTS_START -->/ {print; system("cat hosts_badges.md"); f=1; next}
              /<!-- HOSTS_END -->/ {f=0}
              !f
            ' README.md > README.md.tmp
            mv README.md.tmp README.md
          else
            echo "::warning::Markers not found in README.md"
          fi

      - name: Commit changes
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md
          if ! git diff --quiet --staged; then
            git commit -m "Update host badges ${{ github.event.head_commit.url }}"
            git push
          fi

      - name: Check evaluation results
        run: |
          fail_count="${{ steps.eval.outputs.fail }}"
          if [ "$fail_count" -gt 0 ]; then
            echo "::error::$fail_count host(s) failed to evaluate"
            exit 1
          fi